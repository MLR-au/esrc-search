"use strict";angular.module("searchApp",["ngCookies","ngResource","ngSanitize","ngRoute","ngAnimate"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/about.html",controller:""}).when("/app",{templateUrl:"views/main.html",controller:"MainCtrl",reloadOnSearch:!1}).otherwise({redirectTo:"/"})}]),angular.module("searchApp").controller("MainCtrl",["$scope","$window","$location","SolrService",function(a,b,c,d){var e=angular.element(b);e.bind("resize",function(){a.$apply(function(){f()})});var f=function(){a.w=b.innerWidth,a.h=b.innerHeight,a.t=220,a.w<1024?(a.lpw=Math.floor(.3*a.w)-1,a.rpw=a.w-a.lpw-1):(a.lpw=Math.floor(.25*a.w)-1,a.rpw=a.w-a.lpw-1)};f(),a.$on("show-search-results-details",function(){a.detailsActive=!1}),a.$on("hide-search-results-details",function(){a.detailsActive=!0}),a.toggleDetails=function(){d.toggleDetails()},a.clearAllFilters=function(){d.clearAllFilters()}}]),angular.module("searchApp").directive("searchForm",["$routeParams","$location","SolrService",function(a,b,c){return{templateUrl:"views/search-form.html",restrict:"E",scope:{help:"@",searchType:"@"},link:function(d){d.searchWhat=["1","2","3","4","5","6","7"],d.searchUnion="AND",d.$on("app-ready",function(){d.searchBox=c.term,d.setSearchType(c.searchType!==d.searchType?c.searchType:d.searchType),c.rows!==c.defaultRows&&(c.rows=c.defaultRows)}),d.setSearchBox=function(){if(void 0!==a.q)if(angular.isArray(a.q)){var c=b.search();d.searchBox=a.q[0],b.search("q",c.q[0])}else d.searchBox=a.q;else d.searchBox="*"},d.search=function(){""===d.searchBox&&(d.searchBox="*"),c.searchWhat=d.searchWhat,c.search(d.searchBox,0,!0)},d.setSearchType=function(a){c.searchType=a,"phrase"===c.searchType?(d.keywordSearch=!1,d.phraseSearch=!0):(d.phraseSearch=!1,d.keywordSearch=!0,d.setSearchUnion("AND")),d.search()},d.setSearchUnion=function(a){c.keywordUnion=a,"AND"===c.keywordUnion?(d.keywordAnd=!0,d.keywordOr=!1):(d.keywordAnd=!1,d.keywordOr=!0)},d.setSearchBox(),d.ready=c.init()}}}]),angular.module("searchApp").factory("SolrService",["$rootScope","$http","$routeParams","$route","$location","$timeout","$window","LoggerService","Configuration",function a(b,c,d,e,f,g,h,i,j){function k(){i.init(j.loglevel),i.info("############"),i.info("############ APPLICATION INITIALISED"),i.info("############"),a.filters={},a.dateFilters={},a.results={},a.facets={},a.searchType="keyword";var b;b=void 0!==d.site?d.site:j.site,a.deployment=j[j.deployment],a.site=b,a.solr=a.deployment+"/"+a.site+"/select",i.debug("Solr Service: "+a.solr),i.debug("Site: "+a.site),a.dateOuterBounds(),p(),G()>0&&sessionStorage.removeItem("cq");var c=a.loadData();void 0!==c&&c.site!==a.site&&sessionStorage.removeItem("cq");var c=a.loadData();return void 0!==c?n():o(),!0}function l(){var a=sessionStorage.getItem("cq");return angular.fromJson(b.$eval(a))}function m(){var a=l();h.location=a.site===j.site?"#/":"#/"+a.site}function n(){var c=a.loadData();a.appInit=!0,i.info("Initialising app from saved data"),a.q=c.q,a.filters=c.filters,a.dateFilters=c.dateFilters,a.term=c.term,a.searchType=c.searchType,a.sort=c.sort,a.rows=c.nResults,g(function(){b.$broadcast("app-ready"),a.appInit=!1},300)}function o(){a.appInit=!0,i.info("Bootstrapping app"),a.term=void 0!==d.q?d.q:"*",angular.forEach(d,function(b,c){if(-1!==j.allowedRouteParams.indexOf(c)&&"q"!==c)if("object"==typeof b)for(var d=0;d<b.length;d++)a.filterQuery(c,b[d],!0);else a.filterQuery(c,b,!0)}),angular.forEach(d,function(a,b){-1!==j.allowedRouteParams.indexOf(b)&&f.search(b,null)}),g(function(){b.$broadcast("app-ready"),a.appInit=!1},300)}function p(){if("ESRC"!==a.site){var d={url:a.solr,params:{q:"*:*",rows:1,wt:"json","json.wrf":"JSON_CALLBACK"}};c.jsonp(a.solr,d).then(function(c){a.site_name=c.data.response.docs[0].site_name,a.site_url=c.data.response.docs[0].site_url,i.debug("Searching site: "+a.site_name),b.$broadcast("site-name-retrieved")})}else b.$broadcast("site-name-retrieved")}function q(b){var c,d=[],e=a.term,f=[];angular.forEach(a.searchWhat,function(a){f.push({name:j.searchFields[a].fieldName,weight:j.searchFields[a].weight})}),"*"===e||"~"===e.substr(-1,1)?angular.forEach(f,function(a){d.push(a.name+":("+e+")")}):"keyword"===a.searchType?(e=e.replace(/ /gi," "+a.keywordUnion+" "),angular.forEach(f,function(a){d.push(a.name+":("+e+")")})):angular.forEach(f,function(a){d.push(a.name+':"'+e+'"')}),d=d.join(" OR ");var g=z().join(" AND ");return void 0===g&&(g=""),c=void 0===a.sort?"*"===e?"name asc":"score desc":a.sort,a.resultSort=c,d={url:a.solr,params:{q:d,start:b,rows:a.rows,wt:"json","json.wrf":"JSON_CALLBACK",fq:g,sort:c}},a.q=d,a.q}function r(){var b={date:Date.now(),term:a.term,q:q(0),filters:a.filters,dateFilters:a.dateFilters,searchType:a.searchType,sort:a.sort,site:a.site,nResults:a.results.docs.length};i.debug("Storing the current query: "+b.date),sessionStorage.setItem("cq",angular.toJson(b))}function s(d,e,f){f&&(a.suggestion=void 0,b.$broadcast("search-suggestion-removed")),(d!==a.term||0===e)&&(a.results.docs=[],a.results.start=0),a.term=d;var g=q(e);i.debug(g),c.jsonp(a.solr,g).then(function(b){t(0===b.data.response.numFound&&0===Object.keys(a.filters).length?void 0:b)})}function t(c){if(void 0===c)a.results={term:a.term,total:0,docs:[]};else{var d,e;if(void 0===a.results.docs)d=c.data.response.docs;else for(d=a.results.docs,e=0;e<c.data.response.docs.length;e++)d.push(c.data.response.docs[e]);for(e=0;e<d.length;e++)d[e].sequenceNo=e;a.results={term:a.term,total:c.data.response.numFound,start:parseInt(c.data.responseHeader.params.start),docs:d}}w(),r(),b.$broadcast("search-results-updated")}function u(){var b=a.results.docs.length;s(a.term,b)}function v(d,e,f,g){void 0===e&&(e=0),void 0===f&&(f=-1),void 0===g&&(g="count");var h=q(0);h.params.facet=!0,h.params["facet.field"]=d,h.params["facet.limit"]=f,h.params["facet.sort"]=g,h.params["facet.offset"]=e,h.params.rows=0,c.jsonp(a.solr,h).then(function(c){angular.forEach(c.data.facet_counts.facet_fields,function(c,d){for(var e=[],f=0;f<c.length;f+=2)e.push([c[f],c[f+1],!1]);a.facets[d]=e,b.$broadcast(d+"-facets-updated")})})}function w(){b.$broadcast("update-all-facets"),b.$broadcast("update-date-facets")}function x(b,c,d){if(void 0===a.filters[b])a.filters[b]=[c];else if(-1===a.filters[b].indexOf(c))a.filters[b].push(c);else{var e=a.filters[b].indexOf(c);a.filters[b].splice(e,1),0===a.filters[b].length&&delete a.filters[b]}d!==!0&&(a.results.docs=[],a.results.start=0,s(a.term,0,!0))}function y(b,c,d,e){var f,g,h,i;f=e.split(" - ")[0],g=e.split(" - ")[1],i=void 0!==c&&void 0!==d?c+"-"+d+"-"+e.replace(" - ","_"):b+"-"+e.replace(" - ","_"),a.dateFilters[i]?delete a.dateFilters[i]:(h={from:f+"-01-01T00:00:00Z",to:g+"-12-31T23:59:59Z",facetField:b,label:e,existenceFromField:c,existenceToField:d},a.dateFilters[i]=h),a.results.docs=[],a.results.start=0,s(a.term,0,!0)}function z(){var b,c=[];for(b in a.filters){var d=a.filterUnion[b];c.push(b+':("'+a.filters[b].join('" '+d+' "')+'")')}var e=[];for(b in a.dateFilters){var f=a.dateFilters[b];if(void 0!==f.existenceFromField&&void 0!==f.existenceToField){var g,g="(exist_from:["+j.datasetStart+" TO "+f.to+"]";g+=" AND ",g+="exist_to:["+f.from+" TO "+j.datasetEnd+"])",e.push(g)}else{var g=f.facetField+":["+f.from+" TO "+f.to+"]";e.push(g)}}return c.length>0&&e.length>0?c=c.concat(["("+e.join(" OR ")+")"]):e.length>0&&(c=["("+e.join(" OR ")+")"]),c}function A(){a.filters={},a.dateFilters={},s(a.term,0,!0),b.$broadcast("reset-all-filters")}function B(b){delete a.filters[b],s(a.term,0,!0)}function C(){a.hideDetails=!a.hideDetails,b.$broadcast(a.hideDetails===!0?"hide-search-results-details":"show-search-results-details")}function D(){s(a.term,0)}function E(){var b={url:a.solr,params:{q:"*:*",start:0,rows:1,wt:"json","json.wrf":"JSON_CALLBACK",sort:"exist_from asc"}};c.jsonp(a.solr,b).then(function(b){a.dateStartBoundary=b.data.response.docs[0].exist_from;var d={url:a.solr,params:{q:"*:*",start:0,rows:1,wt:"json","json.wrf":"JSON_CALLBACK",sort:"exist_from desc"}};c.jsonp(a.solr,d).then(function(b){a.dateEndBoundary=b.data.response.docs[0].exist_to})})}function F(d,e,f,g,h){b.$broadcast("reset-date-facets");var i;i=q(0),i.params.rows=0,i.params.facet=!0,i.params["facet.range"]=d,i.params["facet.range.start"]=f+"-01-01T00:00:00Z",i.params["facet.range.end"]=g+"-12-31T23:59:59Z",i.params["facet.range.gap"]="+"+h+"YEARS",c.jsonp(a.solr,i).then(function(c){var f,i,j=c.data.facet_counts.facet_ranges[d].counts;i=[];var k=(new Date).getFullYear();for(f=0;f<j.length;f+=2){var l=parseInt(j[f].split("-")[0])+parseInt(h)-1;l>g&&(l=g),l>k&&(l=k),i.push({rangeStart:parseInt(j[f].split("-")[0]),rangeEnd:l,count:j[f+1]})}var m=d+"_"+e;a.dateFacets[m]=i,b.$broadcast(m+"-facet-data-ready")})}var G=function(){var a=[];return angular.forEach(f.search(),function(b){a.push(b)}),a.length};b.$on("$routeUpdate",function(){if(!a.appInit)if(d.site!==a.site||G()>0)sessionStorage.removeItem("cq"),k(a.deployment,d.site);else{var b=sessionStorage.getItem("cq");null!==b?n(sessionStorage.getItem("cq")):k(a.deployment,d.site)}});var a={results:{},facets:{},dateFacets:{},filters:{},filterUnion:{},dateFilters:{},searchType:"phrase",term:"*",rows:12,defaultRows:12,sort:void 0,resultSort:void 0,hideDetails:!1,init:k,redirectToRoot:m,loadData:l,search:s,saveData:t,nextPage:u,updateFacetCount:v,filterQuery:x,getFilterObject:z,filterDateQuery:y,clearFilter:B,clearAllFilters:A,toggleDetails:C,reSort:D,dateOuterBounds:E,compileDateFacets:F};return a}]),angular.module("searchApp").service("LoggerService",function(){return{logLevel:"ERROR",init:function(a){this.logLevel=a},log:function(a,b){console.log(a+": ",b)},debug:function(a){"DEBUG"===this.logLevel&&this.log("DEBUG",a)},info:function(a){("INFO"===this.logLevel||"DEBUG"==this.logLevel)&&this.log("INFO",a)},error:function(a){("ERROR"===this.logLevel||"INFO"===this.logLevel||"DEBUG"===this.logLevel)&&this.log("ERROR",a)}}}),angular.module("searchApp").directive("searchResults",["$rootScope","$window","SolrService",function(a,b,c){return{templateUrl:"views/search-results.html",restrict:"E",scope:{displayProvenance:"@"},link:function(a){a.showFilters=!1,a.site=c.site,a.summaryActive="",a.detailsActive="active",a.$on("search-results-updated",function(){a.results=c.results,a.filters=c.getFilterObject(),a.results.docs.length!==parseInt(a.results.total)&&(a.scrollDisabled=!1)}),a.$on("search-suggestion-available",function(){a.suggestion=c.suggestion}),a.$on("search-suggestion-removed",function(){a.suggestion=c.suggestion}),a.$on("show-search-results-details",function(){a.summaryActive="",a.detailsActive="active"}),a.$on("hide-search-results-details",function(){a.summaryActive="active",a.detailsActive=""}),a.setSuggestion=function(a){c.search(a,0,!0)},a.loadNextPage=function(){c.nextPage()},a.clearAllFilters=function(){c.clearAllFilters()}}}}]),angular.module("searchApp").directive("genericResultDisplay",["$rootScope","$location","SolrService",function(a,b,c){return{templateUrl:"views/generic-result-display.html",restrict:"E",scope:{data:"=ngModel",displayProvenance:"@"},link:function(b){b.hideDetails=c.hideDetails,a.$on("hide-search-results-details",function(){b.hideDetails=!0}),a.$on("show-search-results-details",function(){b.hideDetails=!1})}}}]),angular.module("searchApp").directive("facetWidget",["SolrService","Configuration",function(a,b){return{templateUrl:"views/facet-widget.html",restrict:"E",scope:{facetField:"@",label:"@",join:"@",isCollapsed:"@",alwaysOpen:"@",showPaginationControls:"@",sortBy:"@"},link:function(c){c.ao=void 0===c.alwaysOpen?!1:angular.fromJson(c.alwaysOpen),c.ic=void 0===c.isCollapsed?!0:angular.fromJson(c.isCollapsed),c.sp=void 0===c.showPaginationControls?!0:angular.fromJson(c.showPaginationControls),c.sb=void 0===c.sortBy?"count":c.sortBy,c.offset=0,c.pageSize=c.sp===!1?-1:10;var d=function(){a.updateFacetCount(c.facetField,c.offset,c.pageSize,c.sb)};c.$on("app-ready",function(){d()}),c.$on("update-all-facets",function(){d()}),void 0===c.join&&(c.join="OR"),a.filterUnion[c.facetField]=c.join,c.$on(c.facetField+"-facets-updated",function(){c.disableWidget=!0;var d=a.filters[c.facetField];void 0===d&&(d=[]);var e=[],f=[];try{var g=b.facetFilter[c.facetField].filterModel,h=b.facetFilter[c.facetField].pivotField}catch(i){}void 0!==g&&void 0!==h&&angular.forEach(a.facets[h],function(a){1==a[2]&&angular.forEach(g[a[0]],function(a){f.push(a)})}),angular.forEach(a.facets[c.facetField],function(a){-1!==d.indexOf(a[0])&&(a[2]=!0,void 0===c.startup&&(c.ic=!1,c.startup=!1)),0!==a[1]&&(c.disableWidget=!1),void 0!==g&&void 0!==h?-1!==f.indexOf(a[0])&&e.push(a):e.push(a)}),c.facets=e}),c.$on("reset-all-filters",function(){angular.forEach(c.facets,function(a,b){c.facets[b][2]=!1}),c.selected=[]}),c.$on("open-all-filters",function(){c.ic=!1}),c.$on("close-all-filters",function(){c.ic=!0}),c.reset=function(){c.offset=0,c.pageSize=c.sp===!1?-1:10,a.clearFilter(c.facetField),d(),angular.forEach(c.facets,function(a,b){c.facets[b][2]=!1}),c.selected=[]},c.facet=function(b){a.filterQuery(c.facetField,b)},c.pageForward=function(){c.offset=c.offset+c.pageSize,d()},c.pageBackward=function(){c.offset=c.offset-c.pageSize,c.offset<0&&(c.offset=0),d()},c.updatePageSize=function(){null===c.pageSize&&(c.pageSize=10),c.pageSize>1e3&&(c.pageSize=1e3),d()}}}}]),angular.module("searchApp").constant("Configuration",{production:"https://solr.esrc.unimelb.edu.au",testing:"https://data.esrc.info/solr",loglevel:"DEBUG",deployment:"production",allowedRouteParams:["q"],site:"ISISrecords",keywordSearchOperator:"AND",datasetStart:"0001-01-01T00:00:00Z",datasetEnd:"2014-12-31T23:59:59Z",searchFields:{1:{fieldName:"author_search",displayName:"Authors",weight:"1"},2:{fieldName:"editor_search",displayName:"Editors",weight:"1"},3:{fieldName:"contributor_search",displayName:"Contributors",weight:"1"},4:{fieldName:"title_search",displayName:"Title",weight:"1"},5:{fieldName:"publisher_search",displayName:"Publisher",weight:"1"},6:{fieldName:"subject_topic_search",displayName:"Subject: topic",weight:"1"},7:{fieldName:"subject_personal_search",displayName:"Subject: person",weight:"1"}}}),angular.module("searchApp").directive("sortResults",["$rootScope","SolrService",function(a,b){return{templateUrl:"views/sort-results.html",restrict:"E",link:function(c){c.sortBy=b.resultSort,a.$on("search-results-updated",function(){c.sortBy=b.resultSort}),c.sort=function(){b.sort=c.sortBy,b.reSort()}}}}]),angular.module("searchApp").directive("dateRangeGraph",["$rootScope","$window","SolrService",function(a,b,c){return{templateUrl:"views/date-range-graph.html",restrict:"E",link:function(b){b.startDateBoundary=void 0,b.endDateBoundary=void 0,a.$on("start-date-facet-data-ready",function(){b.dateFacets=c.startDateFacets})}}}]),angular.module("searchApp").directive("dateFacetWidget",["SolrService",function(a){return{templateUrl:"views/date-facet-widget.html",restrict:"E",scope:{facetField:"@",existenceFromField:"@",existenceToField:"@",id:"@",label:"@",start:"@",end:"@",interval:"@",isCollapsed:"@",alwaysOpen:"@",showPaginationControls:"@"},link:function(b){b.ao=void 0===b.alwaysOpen?!1:angular.fromJson(b.alwaysOpen),b.ic=void 0===b.isCollapsed?!0:angular.fromJson(b.isCollapsed),b.sp=void 0===b.showPaginationControls?!0:angular.fromJson(b.showPaginationControls),void 0===b.start&&console.error("start not defined. Need to pass in a year from which to start the facetting."),void 0===b.interval&&console.error("interval not defined. Need to pass in an interval for the range facetting."),void 0===b.id&&console.error("id not defined. Need to pass in an id for the range facetting."),b.$on("app-ready",function(){void 0===b.end&&(b.end=(new Date).getFullYear()),a.compileDateFacets(b.facetField,b.id,b.start,b.end,b.interval)}),b.$on("update-date-facets",function(){a.compileDateFacets(b.facetField,b.id,b.start,b.end,b.interval)}),b.facets=[],b.$on("reset-date-facets",function(){b.facets=[]}),b.$on(b.facetField+"_"+b.id+"-facet-data-ready",function(){var e=a.dateFacets[b.facetField+"_"+b.id];c(e),d()}),b.$on("reset-all-filters",function(){d()});var c=function(a){b.disableWidget=!0,b.facets=[];var c;angular.forEach(a,function(a){c={start:a.rangeStart,end:a.rangeEnd,label:a.rangeStart+" - "+a.rangeEnd,count:a.count,checked:!1},b.facets.push(c),0!==a.count&&(b.disableWidget=!1)})},d=function(){{var c=[];b.existenceFromField+"-"+b.existenceToField+"-"}angular.forEach(a.dateFilters,function(a){a.existenceFromField===b.existenceFromField&&a.existenceToField===b.existenceToField&&a.facetField===b.facetField&&c.push(a.label)}),angular.forEach(b.facets,function(a,d){-1!==c.indexOf(a.label)?(b.facets[d].checked=!0,void 0===b.startup&&(b.ic=!1,b.startup=!1)):b.facets[d].checked=!1})};b.toggleFacet=function(c){a.filterDateQuery(b.facetField,b.existenceFromField,b.existenceToField,c),d()}}}}]),angular.module("searchApp").filter("dateFilterPrettifier",function(){return function(a){var b=a.replace(/-01-01T/g,"").replace(/-12-31T/g,"");return b=b.replace(/00:00:00Z/g,"").replace(/23:59:59Z/g,"")}}),angular.module("searchApp").directive("provenanceView",function(){return{templateUrl:"views/provenance-view.html",restrict:"E",scope:{data:"=",displayProvenance:"@"},link:function(){}}}),angular.module("searchApp").directive("renderEac",function(){return{templateUrl:"views/render-eac.html",restrict:"E",scope:{data:"=ngModel"},link:function(){}}}),angular.module("searchApp").directive("renderMods",function(){return{templateUrl:"views/render-mods.html",restrict:"E",scope:{data:"=ngModel"},link:function(){}}});