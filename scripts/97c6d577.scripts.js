"use strict";angular.module("searchApp",["ngCookies","ngResource","ngSanitize","ngRoute","ui.bootstrap","infinite-scroll"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).otherwise({redirectTo:"/"})}]),angular.module("searchApp").controller("MainCtrl",["$scope",function(){}]),angular.module("searchApp").directive("searchForm",["$rootScope","SolrService",function(a,b){return{templateUrl:"views/search-form.html",restrict:"E",scope:{help:"@",deployment:"@",site:"@"},link:function(c){c.good_to_go=b.init(c.deployment,c.site),a.$on("search-suggestion-available",function(){c.suggestion=b.suggestion}),a.$on("search-suggestion-removed",function(){c.suggestion=b.suggestion}),c.search=function(){(void 0===c.search_box||""===c.search_box)&&(c.search_box="*"),b.search(c.search_box,0,!0)},c.setSuggestion=function(a){c.search_box=a,c.search()}}}}]),angular.module("searchApp").factory("SolrService",["$rootScope","$http","LoggerService","Configuration",function a(b,c,d,e){function f(b,c){return d.init(e.loglevel),a.site=c,void 0===b&&"production"!==b&&(b="production"),void 0===c?(d.error("Can't run! No solr_core defined!"),!1):(a.solr=e[b]+"/"+c+"/select",d.debug("Solr Service: "+a.solr),d.debug("Site: "+a.site),!0)}function g(e,f,j){if(j&&(a.suggestion=void 0,b.$broadcast("search-suggestion-removed")),(e!==a.term||0===f)&&(a.results.docs=[],a.results.start=0),a.term=e,e.split(" ").length>1)var k='name:("'+e+'"^10 OR text:"'+e+'")';else var k="name:("+e+"^10 OR text:"+e+")";var l=m().join("&fq=");""!==l&&(l="&fq="+l),k=a.solr+"?q="+k+l+"&start="+f+"&rows="+a.rows+"&wt=json&json.wrf=JSON_CALLBACK",d.debug(k),c.jsonp(k).then(function(b){0===b.data.response.numFound&&0===Object.keys(a.facets).length?(h(a.term),1===e.split(" ").length&&"*"!==e?"~"!==e.substr(-1,1)?g(e+"~",0,!1):g(e,0,!1):i(void 0)):i(b)})}function h(e){if(e.split(" ").length>1)var f='name:"'+e+'"';else var f="name:"+e;f=a.solr+"?q="+f+"&rows=0&mlt=off&wt=json&json.wrf=JSON_CALLBACK",d.debug(f),c.jsonp(f).then(function(c){a.suggestion=c.data.spellcheck.suggestions[1].suggestion[0],b.$broadcast("search-suggestion-available")})}function i(c){if(void 0===c)a.results={term:a.term,total:0,docs:[]};else{var d;if(void 0===a.results.docs)d=c.data.response.docs;else{d=a.results.docs;for(var e=0;e<c.data.response.docs.length;e++)d.push(c.data.response.docs[e])}for(var e=0;e<d.length;e++)d[e].sequence_no=e;a.results={term:a.term,total:c.data.response.numFound,start:parseInt(c.data.responseHeader.params.start),docs:d}}b.$broadcast("search-results-updated")}function j(){var b=a.results.start+a.rows;g(a.term,b)}function k(b){var d=a.solr+"?q=*:*&rows=0&facet=true&facet.field="+b+"&wt=json&json.wrf=JSON_CALLBACK";return c.jsonp(d)}function l(b,c){if(void 0===a.facets[b])a.facets[b]=[c];else if(-1===a.facets[b].indexOf(c))a.facets[b].push(c);else{var d=a.facets[b].indexOf(c);a.facets[b].splice(d,1),0===a.facets[b].length&&delete a.facets[b]}a.results.docs=[],a.results.start=0,g(a.term,0,!0)}function m(){var b=[];for(var c in a.facets)b.push(c+':("'+a.facets[c].join('" OR "')+'")');return b}var a={results:{},facets:{},term:"*",rows:10,init:f,search:g,saveData:i,nextPage:j,getFacet:k,facet:l,getFilterObject:m};return a}]),angular.module("searchApp").service("LoggerService",function(){return{log_level:"ERROR",init:function(a){this.log_level=a},log:function(a,b){console.log(a+": ",b)},debug:function(a){"DEBUG"===this.log_level&&this.log("DEBUG",a)},info:function(a){"INFO"===this.log_level&&this.log("INFO",a)},error:function(a){"ERROR"===this.log_level&&this.log("ERROR",a)}}}),angular.module("searchApp").directive("searchResults",["$rootScope","SolrService",function(a,b){return{templateUrl:"views/search-results.html",restrict:"E",link:function(c){c.details_active="active",c.summary_active="",c.scroll_disabled=!0,a.$on("search-results-updated",function(){c.results=b.results,c.filters=b.getFilterObject(),c.results.docs.length!==parseInt(c.results.total)&&(c.scroll_disabled=!1),"active"===c.details_active?a.$broadcast("show-search-results-details"):"active"===c.summary_active&&a.$broadcast("hide-search-results-details")}),c.site=b.site,c.detail_view=function(){a.$broadcast("show-search-results-details"),c.details_active="active",c.summary_active=""},c.list_view=function(){a.$broadcast("hide-search-results-details"),c.summary_active="active",c.details_active=""},c.load_next_page=function(){c.scroll_disabled=!0,b.nextPage()}}}}]),angular.module("searchApp").directive("genericResultDisplay",["$rootScope",function(a){return{templateUrl:"views/generic-result-display.html",restrict:"E",scope:{data:"=ngModel"},link:function(b){b.hide_details=!1,a.$on("show-search-results-details",function(){b.hide_details=!1}),a.$on("hide-search-results-details",function(){b.hide_details=!0})}}}]),angular.module("searchApp").directive("moreLikeThis",function(){return{templateUrl:"views/more-like-this.html",restrict:"E",scope:{source:"@",data:"=ngModel"},link:function(a){a.toggle=!1}}}),angular.module("searchApp").directive("paginationControls",["$rootScope","$location","$anchorScroll","SolrService",function(a,b,c,d){return{templateUrl:"views/pagination-controls.html",restrict:"E",link:function(c){c.show_prev=!1,c.show_next=!1,a.$on("search-results-updated",function(){f()}),c.previous=function(){d.previousPage(),f()},c.next=function(){d.nextPage(),f(),e()};var e=function(){b.hash("top")},f=function(){var a=parseInt(d.results.page_current),b=parseInt(d.results.page_total);c.show_prev=0===a||isNaN(a)?!0:!1,c.show_next=a===b-1||isNaN(b)?!0:!1};f()}}}]),angular.module("searchApp").directive("facetWidget",["SolrService",function(a){return{templateUrl:"views/facet-widget.html",restrict:"E",scope:{facetField:"@",label:"@"},link:function(b){b.isCollapsed=!0,a.getFacet(b.facetField).then(function(a){var c=a.data.facet_counts.facet_fields[b.facetField];b.facets=[];for(var d=[],e=0;e<c.length;e+=2)d.push(c[e]);b.facets=d.sort()}),b.facet=function(c){a.facet(b.facetField,c);for(var d=0;d<b.facets.length;d++)b.facets[d][0]===c&&(b.facets[d][2]=!0)}}}}]),angular.module("searchApp").constant("Configuration",{production:"https://data.esrc.unimelb.edu.au/solr",testing:"https://data.esrc.info/solr",loglevel:"DEBUG"}),angular.module("searchApp").directive("searchFilters",function(){return{templateUrl:"views/search-filters.html",restrict:"E",scope:{filter:"@"},link:function(a){var b=a.filter.split(",");a.filters=[];for(var c=0;c<b.length;c++)a.filters.push(-1!==b[c].indexOf(":::")?{field:b[c].split(":::")[0],label:b[c].split(":::")[1]}:{field:b[c],label:b[c]})}}});