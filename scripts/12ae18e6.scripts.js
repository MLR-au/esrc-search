"use strict";angular.module("searchApp",["ngCookies","ngResource","ngSanitize","ngRoute","ui.bootstrap"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).otherwise({redirectTo:"/"})}]),angular.module("searchApp").controller("MainCtrl",["$scope",function(){}]),angular.module("searchApp").directive("searchForm",["$rootScope","SolrService",function(a,b){return{templateUrl:"views/search-form.html",restrict:"E",scope:{help:"@",deployment:"@",site:"@"},link:function(c){c.good_to_go=b.init(c.deployment,c.site),a.$on("search-suggestion-available",function(){c.suggestion=b.suggestion}),a.$on("search-suggestion-removed",function(){c.suggestion=b.suggestion}),c.search=function(){(void 0===c.search_box||""===c.search_box)&&(c.search_box="*"),b.search(c.search_box,0,!0)},c.setSuggestion=function(a){c.search_box=a,c.search()}}}}]),angular.module("searchApp").factory("SolrService",["$rootScope","$http","LoggerService","Configuration",function a(b,c,d,e){function f(b,c){return d.init(e.loglevel),a.site=c,void 0===b&&"production"!==b&&(b="production"),void 0===c?(d.error("Can't run! No solr_core defined!"),!1):(a.solr=e[b]+"/"+c+"/select",d.debug("Solr Service: "+a.solr),d.debug("Site: "+a.site),!0)}function g(b,e,f){if(f&&k(),a.term=b,b.split(" ").length>1)var j='name:("'+b+'"^10 OR text:"'+b+'")';else var j="name:("+b+"^10 OR text:"+b+")";j=a.solr+"?q="+j+q()+"&start="+e+"&wt=json&json.wrf=JSON_CALLBACK",d.debug(j),c.jsonp(j).then(function(c){0===c.data.response.numFound&&0===Object.keys(a.facets).length?(h(a.term),1===b.split(" ").length&&"*"!==b?"~"!==b.substr(-1,1)?g(b+"~",0,!1):g(b,0,!1):i(void 0)):i(c)})}function h(b){if(b.split(" ").length>1)var e='name:"'+b+'"';else var e="name:"+b;e=a.solr+"?q="+e+"&rows=0&mlt=off&wt=json&json.wrf=JSON_CALLBACK",d.debug(e),c.jsonp(e).then(function(a){j(a)})}function i(c){a.results=void 0===c?{term:a.term,total:0}:{term:a.term,total:c.data.response.numFound,page_current:c.data.response.start,page_total:parseInt(c.data.response.numFound/c.data.response.docs.length+1),docs:c.data.response.docs,mlt:c.data.moreLikeThis},b.$broadcast("search-results-updated")}function j(c){try{a.suggestion=c.data.spellcheck.suggestions[1].suggestion[0],b.$broadcast("search-suggestion-available")}catch(d){}}function k(){a.suggestion=void 0,b.$broadcast("search-suggestion-removed")}function l(){var b=a.results.page_current-1;return g(a.term,b)}function m(){var b=a.results.page_current+1;return g(a.term,b)}function n(b){var e=a.solr+"?q=*:*&rows=0&facet=true&facet.field="+b+"&wt=json&json.wrf=JSON_CALLBACK";return d.debug(e),c.jsonp(e)}function o(b,c){if(void 0===a.facets[b])a.facets[b]=[c];else if(-1===a.facets[b].indexOf(c))a.facets[b].push(c);else{var d=a.facets[b].indexOf(c);a.facets[b].splice(d,1),0===a.facets[b].length&&delete a.facets[b]}g(a.term,0,!0)}function p(){var b=[];for(var c in a.facets)b.push(c+':("'+a.facets[c].join('" OR "')+'")');return b}function q(){var a=p().join(" AND ");return""!==a&&(a=" AND "+a),a}var a={results:{},facets:{},term:"*",init:f,search:g,saveData:i,previousPage:l,nextPage:m,getFacet:n,facet:o,getFilterObject:p};return a}]),angular.module("searchApp").service("LoggerService",function(){return{log_level:"ERROR",init:function(a){this.log_level=a},log:function(a,b){console.log(a+": ",b)},debug:function(a){"DEBUG"===this.log_level&&this.log("DEBUG",a)},info:function(a){"INFO"===this.log_level&&this.log("INFO",a)},error:function(a){"ERROR"===this.log_level&&this.log("ERROR",a)}}}),angular.module("searchApp").directive("searchResults",["$rootScope","SolrService",function(a,b){return{templateUrl:"views/search-results.html",restrict:"E",link:function(c){a.$on("search-results-updated",function(){c.results=b.results,c.filters=b.getFilterObject()})}}}]),angular.module("searchApp").directive("genericResultDisplay",function(){return{templateUrl:"views/generic-result-display.html",restrict:"E",scope:{data:"=ngModel"},link:function(){}}}),angular.module("searchApp").directive("moreLikeThis",function(){return{templateUrl:"views/more-like-this.html",restrict:"E",scope:{source:"@",data:"=ngModel"},link:function(a){a.toggle=!1}}}),angular.module("searchApp").directive("paginationControls",["$rootScope","$location","$anchorScroll","SolrService",function(a,b,c,d){return{templateUrl:"views/pagination-controls.html",restrict:"E",link:function(c){c.show_prev=!1,c.show_next=!1,a.$on("search-results-updated",function(){f()}),c.previous=function(){d.previousPage(),f()},c.next=function(){d.nextPage(),f(),e()};var e=function(){b.hash("top")},f=function(){var a=parseInt(d.results.page_current),b=parseInt(d.results.page_total);c.show_prev=0===a||isNaN(a)?!0:!1,c.show_next=a===b-1||isNaN(b)?!0:!1};f()}}}]),angular.module("searchApp").directive("facetWidget",["SolrService",function(a){return{templateUrl:"views/facet-widget.html",restrict:"E",scope:{facetField:"@",label:"@"},link:function(b){b.isCollapsed=!0,a.getFacet(b.facetField).then(function(a){var c=a.data.facet_counts.facet_fields[b.facetField];b.facets=[];for(var d=[],e=0;e<c.length;e+=2)d.push(c[e]);b.facets=d.sort()}),b.facet=function(c){a.facet(b.facetField,c);for(var d=0;d<b.facets.length;d++)b.facets[d][0]===c&&(b.facets[d][2]=!0)}}}}]),angular.module("searchApp").constant("Configuration",{production:"https://data.esrc.unimelb.edu.au/solr",testing:"https://data.esrc.info/solr",loglevel:"DEBUG"}),angular.module("searchApp").directive("searchFilters",function(){return{templateUrl:"views/search-filters.html",restrict:"E",scope:{filter:"@"},link:function(a){var b=a.filter.split(",");a.filters=[];for(var c=0;c<b.length;c++)a.filters.push(-1!==b[c].indexOf(":::")?{field:b[c].split(":::")[0],label:b[c].split(":::")[1]}:{field:b[c],label:b[c]})}}});